Xjs.loadedXjs.push("video/VideoPlay");
Xjs.namespace("snsoftx.video");snsoftx.video.VideoPlay=function(domId,cfg,playUrl){var attachInVDOM=this.attachInVideoDOM(),_attachInDOM=document.getElementById(domId||(attachInVDOM?"video-player":"video-player-wrapper"));if(!_attachInDOM&&domId==null)_attachInDOM=document.querySelector("video");this.attachInDOM=_attachInDOM;if(attachInVDOM){this.videoElement=this.attachInDOM;this.videoElement.onloadedmetadata=this.onLoadedMetadata.createDelegate(this);}else {this.videoElement=null;for(;this.attachInDOM.childNodes.length>0;)this.attachInDOM.removeChild(this.attachInDOM.childNodes[0]);}Xjs.apply(this,cfg);this.init();if(this.fitSize)window.addEventListener("resize",this.onWindowResized.createDelegate(this),false);if(playUrl)this.play(playUrl);};Xjs.apply(snsoftx.video.VideoPlay.prototype,{attachInVideoDOM:Xjs.trueFn,onLoadedMetadata:function(){this.updateVideoPos();},init:Xjs.emptyFn,play:function(url){this.videoElement.src=url;this.videoElement.play();},pause:function(){this.videoElement.pause();},stop:function(){this.videoElement.pause();},onVideoError:function(err){alert("播放错误：");},getVideoWidth:function(){return this.videoElement?this.videoElement.videoWidth:0;},getVideoHeight:function(){return this.videoElement?this.videoElement.videoHeight:0;},onVideoPlayReady:Xjs.emptyFn,onVideoPlay:function(){;this.updateVideoPos();},onVideoResize:function(){this.updateVideoPos();},onWindowResized:function(){this.updateVideoPos();},setVideoViewSize:function(w,h){if(this.videoElement){this.videoElement.style.width=w+"px";this.videoElement.style.height=h+"px";}if(this.attachInDOM&&this.attachInDOM!=this.videoElement){this.attachInDOM.style.width=w+"px";this.attachInDOM.style.height=h+"px";}},updateVideoPos:function(){var viewH=Xjs.DOM.getViewportHeight()-(this.padding&&this.padding.height?this.padding.height:0),viewW=Xjs.DOM.getViewportWidth()-(this.padding&&this.padding.width?this.padding.width:0);if(this.fitSize==1){var videoWidth=this.getVideoWidth(),videoHeight=this.getVideoHeight(),w=videoWidth||this.defaultVideoWidth||0,h=videoHeight||this.defaultVideoHeight||0;if(h<=0||w<=0)return;var maxW=viewW,maxH=viewH;if(this.listener&&this.listener.getVideoViewMaxSize){var s=this.listener.getVideoViewMaxSize(viewW,viewH);if(s){if(s.width>0)maxW=s.width;if(s.height>0)maxH=s.height;}}if(w>maxW){h=maxW*h/w;w=maxW;}if(h>maxH){w=maxH*w/h;h=maxH;}this.setVideoViewSize(w,h);if(this.listener&&this.listener.onVideoViewSizeChanged)this.listener.onVideoViewSizeChanged(w,h);}},setListener:function(l){this.listener=l;}});Xjs.apply(snsoftx.video.VideoPlay,{$new:function(type,domId,cfg,playUrl){switch((type||"").toLowerCase()){case "hls":return new snsoftx.video.HLSVideoPlay(domId,cfg,playUrl);case "flv":return new snsoftx.video.FLVVideoPlay(domId,cfg,playUrl);case "clappr":return new snsoftx.video.ClapprVideoPlay(domId,cfg,playUrl);case "null":return null;default:return new snsoftx.video.VideoPlay(domId,cfg,playUrl);}}});snsoftx.video.ClapprVideoPlay=function(domId,cfg,playUrl){snsoftx.video.ClapprVideoPlay.superclass.constructor.call(this,domId,cfg,playUrl);};Xjs.extend(snsoftx.video.ClapprVideoPlay,snsoftx.video.VideoPlay,{ClapprJSUrl:Xjs.ROOTPATH+"jslib/clappr/Clappr.js",attachInVideoDOM:Xjs.falseFn,init:Xjs.emptyFn,play:function(url){var _this=this;Xjs.JsLoad.asynLoadJS(this.ClapprJSUrl).then(()=>{_this._play(url);});},pause:function(){if(this.player)this.player.pause();},stop:function(){if(this.player)this.player.stop();},_play:function(url){if(!this.player){this.player=new Clappr.Player({});this.player.attachTo(this.attachInDOM);}if(url)this.player.load(url);this.player.play();}});snsoftx.video.FLVVideoPlay=function(domId,cfg,playUrl){snsoftx.video.FLVVideoPlay.superclass.constructor.call(this,domId,cfg,playUrl);};Xjs.extend(snsoftx.video.FLVVideoPlay,snsoftx.video.VideoPlay,{flvjsUrl:"https://cdn.bootcdn.net/ajax/libs/flv.js/1.5.0/flv.min.js",init:Xjs.emptyFn,play:function(url){this.destroy();var _this=this;Xjs.JsLoad.asynLoadJS(this.flvjsUrl).then(()=>{_this._play(url);});},flvConfig:function(){if(!this._cfged){this._cfged=true;var c=window.flvjs.LoggingControl;c.enableDebug=false;c.enableInfo=false;c.enableVerbose=false;c.enableWarn=false;}},_play:function(url){this.flvConfig();this.flvPlayer=window.flvjs.createPlayer({type:"flv",url:url});this.flvPlayer.attachMediaElement(this.videoElement);this.flvPlayer.load();this.videoElement.play();},pause:function(){if(this.flvPlayer)this.flvPlayer.pause();},stop:function(){this.destroy();},destroy:function(){if(this.flvPlayer){this.flvPlayer.unload();this.flvPlayer.detachMediaElement();this.flvPlayer.destroy();this.flvPlayer=null;}}});snsoftx.video.HLSVideoPlay=function(domId,cfg,playUrl){snsoftx.video.HLSVideoPlay.superclass.constructor.call(this,domId,cfg,playUrl);};Xjs.extend(snsoftx.video.HLSVideoPlay,snsoftx.video.VideoPlay,{HLSJSUrl:"http://localhost/demo-web/jslib/hls/hls.js",init:Xjs.emptyFn,play:function(url){var _this=this;Xjs.JsLoad.asynLoadJS(this.HLSJSUrl).then(()=>{_this._play(url);});},_play:function(url){if(!this.hls){this.hls=new Hls();this.fn$onVideoPlayReady=this.onVideoPlayReady.createDelegate(this);}this.hls.attachMedia(this.videoElement);this.hls.loadSource(url);this.hls.on(Hls.Events.MEDIA_ATTACHED,this.fn$onVideoPlayReady);},onVideoPlayReady:function(){this.videoElement.play();}});snsoftx.video.RawVideoPlay=function(domId,cfg){snsoftx.video.RawVideoPlay.superclass.constructor.call(this,domId,cfg,null);this.bufferedMediaSourceChunk=[];this.mediaSource=new MediaSource();if(this.videoElement.src)URL.revokeObjectURL(this.videoElement.src);this.videoElement.src=URL.createObjectURL(this.mediaSource);this.mediaSource.addEventListener("sourceopen",this._fn$onMediaSourceOpen=Function.bindAsEventListener(this.onMediaSourceOpen,this));};Xjs.extend(snsoftx.video.RawVideoPlay,snsoftx.video.VideoPlay,{setMediaMime:function(mimeType){this.mimeType=mimeType;},onMediaSourceOpen:function(e){if(this._fn$onMediaSourceOpen){this.mediaSource.removeEventListener("sourceopen",this._fn$onMediaSourceOpen);this._fn$onMediaSourceOpen=null;}if(!this.sourceBuffer){this.sourceBuffer=this.mediaSource.addSourceBuffer(this.mimeType);this.sourceBuffer.addEventListener("updateend",Function.bindAsEventListener(this.onSourceBufferUpdateend,this));};this._mediaSourceAppendable=true;if(this.listener&&this.listener.onMediaSourceOpen)this.listener.onMediaSourceOpen(this);this._appendMediaSource();},onSourceBufferUpdateend:function(e){;this._mediaSourceAppendable=true;this._appendMediaSource();},getBufferedMediaSourceChunk:function(){return this.bufferedMediaSourceChunk;},_appendMediaSource:function(){if(this._mediaSourceAppendable&&this.bufferedMediaSourceChunk.length>0&&this.mediaSource.readyState=="open"){var chunk=this.bufferedMediaSourceChunk.shift();if(chunk==null)this.mediaSource.endOfStream();else this.sourceBuffer.appendBuffer(chunk);this._mediaSourceAppendable=false;}if(this.bufferedMediaSourceChunk.length==0&&this.mediaSource.readyState=="open"&&this.listener&&this.listener.onMediaSourceChunkRequest)this.listener.onMediaSourceChunkRequest(this);},appendMediaSourceChunk:function(chunk){this.bufferedMediaSourceChunk.push(chunk);this._appendMediaSource();}});